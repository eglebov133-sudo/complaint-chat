"""
Сервис интеграции с LLM (OpenRouter API)
С динамической генерацией вопросов
"""
import requests
import json
from typing import List, Dict, Optional
from config import Config


class LLMService:
    def __init__(self):
        self.api_key = Config.OPENROUTER_API_KEY
        self.base_url = Config.OPENROUTER_BASE_URL
        self.model = Config.LLM_MODEL
        
    def _make_request(self, messages: List[Dict], temperature: float = 0.7, model_override: Optional[str] = None) -> Optional[str]:
        """Отправка запроса к OpenRouter API с retry логикой"""
        if not self.api_key:
            print("LLM API Error: No API key configured")
            return None
        
        # Используем переданную модель или дефолтную
        model_to_use = model_override or self.model
            
        headers = {
            "Authorization": f"Bearer {self.api_key}",
            "Content-Type": "application/json",
            "HTTP-Referer": "http://localhost:5000",
            "X-Title": "Complaint Chat Assistant"
        }
        
        payload = {
            "model": model_to_use,
            "messages": messages,
            "temperature": temperature,
            "max_tokens": 4000  # Увеличено для длинных жалоб
        }
        
        print(f"LLM API: Using model {model_to_use}")
        
        import time
        max_retries = 3
        
        for attempt in range(max_retries):
            try:
                print(f"LLM API: Attempt {attempt + 1}/{max_retries}...")
                response = requests.post(
                    f"{self.base_url}/chat/completions",
                    headers=headers,
                    json=payload,
                    timeout=90  # Увеличен таймаут
                )
                if not response.ok:
                    print(f"LLM API Error: {response.status_code} - {response.text[:200]}")
                    if attempt < max_retries - 1:
                        time.sleep(2 ** attempt)  # Exponential backoff
                        continue
                    return None
                data = response.json()
                content = data["choices"][0]["message"]["content"]
                print(f"LLM API: Success! Response length: {len(content)} chars")
                return content
            except Exception as e:
                print(f"LLM API Error (attempt {attempt + 1}): {e}")
                if attempt < max_retries - 1:
                    time.sleep(2 ** attempt)  # Wait 1s, 2s, 4s
                continue
        
        print("LLM API: All retries failed")
        return None
    
    def generate_next_question(self, state) -> Optional[Dict]:
        """
        Генерация следующего вопроса или решение что информации достаточно.
        LLM анализирует собранную информацию и решает, что делать дальше.
        
        Returns:
            {"ready": True} - если информации достаточно
            {"question": "...", "options": [...] or None} - следующий вопрос
            None - если LLM недоступен
        """
        if not self.api_key:
            return None
        
        # ОБЯЗАТЕЛЬНО: Если нет данных о компании — сначала спрашиваем компанию
        has_company = state.data.get("company_name") or state.data.get("company_inn")
        if not has_company:
            # Проверяем, не был ли уже задан вопрос о компании
            company_question_asked = False
            for qa in state.qa_pairs:
                q = qa.get("question", "").lower()
                if "организаци" in q or "компани" in q or "на кого" in q:
                    company_question_asked = True
                    break
            
            if not company_question_asked:
                return {
                    "ready": False,
                    "question": "На какую организацию или компанию вы хотите подать жалобу?",
                    "options": None,
                    "input_type": "autocomplete_company"
                }
        
        # Формируем контекст из собранных Q&A пар
        qa_context = ""
        for i, qa in enumerate(state.qa_pairs, 1):
            qa_context += f"{i}. Вопрос: {qa['question']}\n   Ответ: {qa['answer']}\n\n"
        
        if not qa_context:
            qa_context = "Диалог только начался."
        
        system_prompt = """Ты — дружелюбный помощник по составлению жалоб. Твоя задача — собрать информацию о проблеме клиента через ПРОСТЫЕ вопросы с ГОТОВЫМИ ВАРИАНТАМИ ответов.

## ГЛАВНОЕ ПРАВИЛО
⚠️ ПОЛЬЗОВАТЕЛЬ НЕ ХОЧЕТ И НЕ УМЕЕТ ФОРМУЛИРОВАТЬ МЫСЛИ!
- ВСЕГДА давай 8 готовых вариантов ответа (если столько возможно для вопроса)
- Варианты должны быть конкретными и понятными
- Пользователь должен ТОЛЬКО КЛИКАТЬ, а не печатать
- НЕ добавляй вариант "Другое" — у пользователя всегда есть поле ввода текста

## СТРАТЕГИЯ ОПРОСА

### Шаг 1: На кого жалуемся? (ОБЯЗАТЕЛЬНО!)
⚠️ ПЕРВЫМ ДЕЛОМ узнай название организации/компании на которую жалуемся!
- Вопрос: "На какую организацию или компанию вы хотите пожаловаться?"
- input_type: "autocomplete_company" (пользователь введёт название или ИНН)
- options: null

### Шаг 2: Что случилось? (конкретные ситуации)
Вместо "Расскажите о проблеме" спрашивай:
- "Выберите, что произошло:" + варианты типичных ситуаций

### Шаг 3: Когда это было?
- "Неделю назад", "Месяц назад", "Полгода назад", "Больше года", "Продолжается сейчас"

### Шаг 4: Пытались решить?
- "Да, обращался письменно", "Да, звонил/говорил устно", "Нет, сразу решил жаловаться"

### Шаг 5: Есть доказательства?
- "Есть документы/договоры", "Есть фото/видео", "Есть переписка", "Есть свидетели", "Ничего нет"

### Шаг 6: Какой ущерб?
- "Потерял деньги", "Потерял время", "Нервы/стресс", "Проблемы со здоровьем", "Другой ущерб"

## ПРИМЕРЫ ХОРОШИХ ВОПРОСОВ

❌ ПЛОХО: "Что именно произошло? Расскажите подробнее."
✅ ХОРОШО: "Что именно вас не устроило?" + варианты:
- "Не выполнили работу/услугу"
- "Сделали плохо/некачественно"  
- "Взяли деньги и пропали"
- "Нахамили/нагрубили"
- "Отказали без причины"

❌ ПЛОХО: "Опишите ситуацию с полицией"
✅ ХОРОШО: "Что произошло с полицией?" + варианты:
- "Отказались принять заявление"
- "Не приехали на вызов"
- "Грубо обращались"
- "Бездействуют по моему делу"
- "Потеряли документы"

## ПРАВИЛА
1. ОДИН вопрос = ОДНА тема
2. Старайся давать 8 вариантов (минимум 4, если тема узкая)
3. Варианты — короткие фразы (не более 5-6 слов)
4. НЕ добавляй "Другое" — поле для ввода текста всегда доступно
5. Вопрос — простым языком, без юридических терминов
6. Минимум 6-8 вопросов для полной картины
7. ⛔ НИКОГДА не спрашивай "Куда хотите пожаловаться?" или "Какой орган выбрать?" — выбор адресатов происходит АВТОМАТИЧЕСКИ на следующем этапе!

## ТИПЫ ВВОДА
- "options" — ОСНОВНОЙ ТИП, используй почти всегда
- "autocomplete_company" — ТОЛЬКО когда нужно название организации
- "autocomplete_address" — ТОЛЬКО когда нужен точный адрес
- "autocomplete_fio" — ТОЛЬКО когда нужно ФИО конкретного человека
- "text" — ТОЛЬКО для номеров (телефон, договор) или мелких уточнений

## ФОРМАТ ОТВЕТА (строго JSON)
{"ready": false, "question": "Простой вопрос?", "options": ["Вариант 1", "Вариант 2", "Вариант 3"], "input_type": "options"}

Когда собрано ДОСТАТОЧНО информации (минимум 6 ответов):
{"ready": true}"""

        user_type = state.data.get('user_type', 'individual')
        user_type_label = "организация / ИП" if user_type == "organization" else "физическое лицо (обычный человек)"
        
        user_prompt = f"""Категория: {state.data.get('category_name', 'Не указана')}
Заявитель: {user_type_label}

СОБРАННАЯ ИНФОРМАЦИЯ:
{qa_context}

Количество ответов: {len(state.qa_pairs)}

⚠️ ВАЖНО: варианты ответов должны соответствовать типу заявителя!
- Для организации: вопросы про договоры, контрагентов, юридические аспекты, убытки бизнеса
- Для физлица: вопросы про бытовые проблемы, личный ущерб, нарушение прав потребителя

Проанализируй: понятна ли уже СУТЬ проблемы и есть ли все детали для мощной жалобы?
- Если нет — задай следующий важный вопрос
- Если да (минимум 8 ответов и понятна суть) — верни ready: true

JSON:"""

        messages = [
            {"role": "system", "content": system_prompt},
            {"role": "user", "content": user_prompt}
        ]
        
        result = self._make_request(messages, temperature=0.6)
        
        if result:
            try:
                # Извлекаем JSON из ответа
                json_str = self._extract_json(result)
                if json_str:
                    parsed = json.loads(json_str)
                    return parsed
            except Exception as e:
                print(f"Failed to parse LLM response: {e}")
                print(f"Response was: {result[:300]}")
                return None
        
        return None
    
    def _extract_json(self, text: str) -> Optional[str]:
        """Извлекает JSON объект из текста"""
        text = text.strip()
        
        # Если весь текст - это JSON
        if text.startswith("{") and text.endswith("}"):
            return text
        
        # Ищем JSON в markdown блоках
        if "```json" in text:
            try:
                return text.split("```json")[1].split("```")[0].strip()
            except:
                pass
        
        if "```" in text:
            parts = text.split("```")
            for part in parts:
                part = part.strip()
                if part.startswith("{"):
                    # Проверяем что это валидный JSON
                    try:
                        json.loads(part)
                        return part
                    except:
                        pass
        
        # Ищем JSON по скобкам (поддерживает вложенность)
        start = text.find("{")
        if start == -1:
            return None
        
        depth = 0
        in_string = False
        escape = False
        
        for i, c in enumerate(text[start:], start):
            if escape:
                escape = False
                continue
            if c == "\\":
                escape = True
                continue
            if c == '"' and not escape:
                in_string = not in_string
                continue
            if in_string:
                continue
            if c == "{":
                depth += 1
            elif c == "}":
                depth -= 1
                if depth == 0:
                    json_candidate = text[start:i+1]
                    try:
                        json.loads(json_candidate)
                        return json_candidate
                    except:
                        # Продолжаем искать
                        pass
        
        return None
    
    def generate_complaint_text(self, context: Dict) -> str:
        """Генерация текста жалобы на основе ВСЕЙ собранной информации"""
        
        # Формируем подробный контекст из Q&A пар
        qa_text = ""
        if context.get("qa_pairs"):
            for i, qa in enumerate(context["qa_pairs"], 1):
                qa_text += f"{i}. {qa['question']}\n   Ответ: {qa['answer']}\n\n"
        
        # Также используем raw conversation если есть
        conversation = context.get("conversation", "")
        
        system_prompt = """Ты — элитный юрист с 20-летним опытом защиты прав граждан в суде. Твоя задача — написать МОЩНУЮ, УБЕДИТЕЛЬНУЮ жалобу, которая произведёт WOW-эффект на клиента.

## ЦЕЛЬ
Клиент должен посмотреть на жалобу и подумать: "Вау! Я бы никогда так круто не написал! Это профессионал!"

## СТРУКТУРА ИДЕАЛЬНОЙ ЖАЛОБЫ

### 1. ШАПКА (строго по формату)
```
В [название органа]
[адрес органа, если известен]

от [ФИО заявителя]
проживающего по адресу: [адрес]
тел.: [телефон]
email: [email]

ЖАЛОБА
(на [краткое описание предмета жалобы])
```

### 2. ВСТУПЛЕНИЕ (1 абзац)
Ёмко и профессионально изложи СУТЬ нарушения. Начни с фразы типа:
"Я, [ФИО], вынужден(а) обратиться к Вам в связи с грубым нарушением моих законных прав..."

### 3. ФАКТИЧЕСКИЕ ОБСТОЯТЕЛЬСТВА (2-4 абзаца)
- Хронология событий (даты, факты, детали)
- Кто нарушитель (ФИО, должность, организация)
- Что именно нарушено
- Какие действия предпринимались для решения
- Какие ответы получены

### 4. ПРАВОВОЕ ОБОСНОВАНИЕ (ключевой раздел!)
Обязательно укажи нарушенные нормы права:
- Конституция РФ (ст. 2, 17, 18, 45, 46 - права граждан)
- Закон о защите прав потребителей (если применимо)
- ЖК РФ, ТК РФ, ГК РФ, КоАП РФ — в зависимости от ситуации
- Используй формулировки: "в нарушение ст. X закона Y", "что противоречит..."

### 5. ПРОСИТЕЛЬНАЯ ЧАСТЬ (чёткие требования)
"На основании изложенного, руководствуясь [ссылки на законы], ПРОШУ:
1. Провести проверку...
2. Привлечь к ответственности...
3. Обязать [нарушителя] устранить...
4. О результатах рассмотрения уведомить меня в установленный законом срок."

### 6. ПРИЛОЖЕНИЯ И ПОДПИСЬ
"Приложения: [список, если есть]

Дата: _______________
Подпись: _______________ / [ФИО]"

## СТИЛЬ
- Официальный, уверенный, НЕ просящий, а ТРЕБУЮЩИЙ
- Без эмоций, только факты и закон
- Юридически грамотный язык
- Чёткие формулировки без воды

## КРИТИЧЕСКИ ВАЖНО
- Используй ВСЮ информацию из диалога — каждый факт!
- ⚠️ НИКОГДА НЕ ПРИДУМЫВАЙ ДАННЫЕ! Если отчество не указано — не добавляй его! Если нет адреса — оставь "[адрес не указан]"
- Если ФИО неполное (только имя и фамилия) — пиши как есть, БЕЗ отчества
- Жалоба должна быть объёмной и солидной (минимум 1-2 страницы)
- Покажи, что за человеком стоит знание закона"""

        user_prompt = f"""НАПИШИ МОЩНУЮ ЖАЛОБУ на основе собранной информации:

КАТЕГОРИЯ: {context.get('category_name', 'Общая жалоба')}

═══════════════════════════════════════
МАТЕРИАЛЫ ДЕЛА (из опроса клиента):
═══════════════════════════════════════
{qa_text if qa_text else conversation if conversation else 'Детали не предоставлены'}

═══════════════════════════════════════
ДАННЫЕ ЗАЯВИТЕЛЯ:
═══════════════════════════════════════
• ФИО: {context.get('name', '[Не указано]')}
• Адрес: {context.get('address', '[Не указан]')}
• Телефон: {context.get('phone', '[Не указан]')}
• Email: {context.get('email', '[Не указан]')}

═══════════════════════════════════════

Создай ПРОФЕССИОНАЛЬНУЮ жалобу, которая произведёт WOW-эффект.
Используй ВСЕ факты. Ссылайся на конкретные статьи законов.
Жалоба должна быть готова к немедленной отправке."""

        messages = [
            {"role": "system", "content": system_prompt},
            {"role": "user", "content": user_prompt}
        ]
        
        result = self._make_request(messages, temperature=0.4)
        
        if result:
            return result
        
        # Fallback: генерируем простой текст без LLM
        return self._generate_fallback_complaint(context)
    
    def _generate_fallback_complaint(self, context: Dict) -> str:
        """Генерация текста жалобы без LLM (fallback)"""
        
        recipient = context.get('recipient_name', '[Наименование органа]')
        name = context.get('name', '[ФИО]')
        address = context.get('address', '[Адрес]')
        phone = context.get('phone', '[Телефон]')
        email = context.get('email', '[Email]')
        category = context.get('category_name', '[Категория]')
        
        # Собираем описание из Q&A пар
        description_parts = []
        if context.get("qa_pairs"):
            for qa in context["qa_pairs"]:
                description_parts.append(f"- {qa['answer']}")
        description = "\n".join(description_parts) if description_parts else "[Описание]"
        
        return f"""
В {recipient}

от {name}
Адрес: {address}
Телефон: {phone}
Email: {email}

ЖАЛОБА

Я, {name}, обращаюсь к Вам с жалобой по следующему вопросу.

Категория обращения: {category}

Описание ситуации:
{description}

На основании изложенного, прошу:
1. Провести проверку по изложенным фактам
2. Принять меры по устранению нарушений
3. Привлечь виновных лиц к ответственности
4. Уведомить меня о результатах рассмотрения жалобы в установленные законом сроки

Приложения: нет

Дата: _______________
Подпись: _______________

С уважением,
{name}
""".strip()
    
    def generate_recipients(self, context: Dict) -> Optional[Dict]:
        """LLM анализирует ситуацию и рекомендует получателей жалобы"""
        
        # Формируем контекст из Q&A пар
        qa_text = ""
        if context.get("qa_pairs"):
            for i, qa in enumerate(context["qa_pairs"], 1):
                qa_text += f"{i}. {qa['question']}\n   Ответ: {qa['answer']}\n\n"
        
        system_prompt = """Ты — эксперт по российскому законодательству. Проанализируй жалобу и определи МАКСИМАЛЬНО РЕЛЕВАНТНЫХ получателей с объяснением почему туда стоит обратиться.

## ДОСТУПНЫЕ ПОЛУЧАТЕЛИ (с описанием юрисдикции):

### ПРОКУРАТУРА (надзор над всеми)
- **prosecution** — Прокуратура РФ
  Юрисдикция: Надзор за ВСЕМИ органами власти и организациями
  Когда эффективно: Другие органы бездействуют, системные нарушения, коррупция
  Почему сюда: Могут привлечь к ответственности любого чиновника, дать указания другим органам

### ТРУДОВЫЕ СПОРЫ  
- **git** — Трудовая инспекция (ГИТ)
  Юрисдикция: Контроль соблюдения ТК РФ
  Когда эффективно: Зарплата, увольнение, условия труда, отпуска
  Почему сюда: Проведут проверку, выдадут предписание работодателю, оштрафуют
  
- **rostrud** — Роструд (федеральный уровень)
  Юрисдикция: Вышестоящий орган над всеми ГИТ в стране
  Когда эффективно: Местная ГИТ не помогла
  Почему сюда: Дадут указания региональной инспекции

### ЗАЩИТА ПОТРЕБИТЕЛЕЙ
- **rospotrebnadzor** — Роспотребнадзор
  Юрисдикция: Права потребителей, санитария, качество
  Когда эффективно: Товары, услуги, возврат денег, обман
  Почему сюда: Проверят магазин/компанию, оштрафуют, помогут вернуть деньги

- **aro** — Финансовый омбудсмен
  Юрисдикция: Споры с банками/страховыми до 500 тыс. ₽
  Когда эффективно: Любой спор с банком на сумму до 500 000 ₽
  Почему сюда: БЕСПЛАТНО, решение обязательно для банка, быстрее суда

### ЖКХ
- **housing_inspection** — Жилищная инспекция
  Юрисдикция: Контроль УК и ТСЖ
  Когда эффективно: Проблемы с управляющей компанией, начисления, содержание дома
  Почему сюда: Могут обязать УК исправить нарушения, сделать перерасчёт, лишить лицензии

### ПРАВООХРАНА
- **police** — Полиция (МВД)
  Юрисдикция: Преступления и правонарушения
  Когда эффективно: Мошенничество, кража, угрозы, побои
  Почему сюда: Обязаны принять заявление, могут возбудить уголовное дело

- **investigative_committee** — Следственный комитет (СК)
  Юрисдикция: Тяжкие преступления, коррупция должностных лиц
  Когда эффективно: Серьёзные дела, бездействие полиции
  Почему сюда: Независимы от МВД, расследуют коррупцию чиновников

### ФИНАНСЫ
- **central_bank** — Центральный банк РФ
  Юрисдикция: Регулятор всех банков, МФО, страховых
  Когда эффективно: Незаконные списания, скрытые комиссии, навязывание услуг
  Почему сюда: БАНКИ БОЯТСЯ жалоб в ЦБ — могут оштрафовать, отозвать лицензию

### АНТИМОНОПОЛИЯ И РЕКЛАМА
- **fas** — ФАС России
  Юрисдикция: Конкуренция, реклама, госзакупки
  Когда эффективно: Обманная реклама, завышенные цены монополиста
  Почему сюда: Штрафы нарушителям, защита от недобросовестной конкуренции

### ПЕРСОНАЛЬНЫЕ ДАННЫЕ
- **roskomnadzor** — Роскомнадзор
  Юрисдикция: Персональные данные, СМИ, связь
  Когда эффективно: Утечка данных, спам-звонки, незаконная передача информации
  Почему сюда: Крупные штрафы за утечки, могут заблокировать сайт нарушителя

### МЕДИЦИНА
- **roszdravnadzor** — Росздравнадзор
  Юрисдикция: Качество медицинской помощи
  Когда эффективно: Врачебная ошибка, отказ в помощи, плохое лечение
  Почему сюда: Проверят клинику, могут лишить лицензии

- **oms_fond** — Фонд ОМС
  Юрисдикция: Бесплатная медпомощь по полису ОМС
  Когда эффективно: Требуют деньги за бесплатное, очереди, отказ по ОМС
  Почему сюда: Защищают застрахованных, накажут больницу рублём

### ОБРАЗОВАНИЕ
- **rosobrnadzor** — Рособрнадзор
  Юрисдикция: Контроль качества образования
  Когда эффективно: Нарушения в школе/вузе, поборы, некачественное обучение
  Почему сюда: Могут проверить учреждение, лишить аккредитации

### УПОЛНОМОЧЕННЫЕ ПО ПРАВАМ
- **ombudsman** — Уполномоченный по правам человека
  Юрисдикция: Защита конституционных прав
  Когда эффективно: Произвол властей, дискриминация
  Почему сюда: Независим, может обратиться в суд в ваших интересах

- **children_ombudsman** — Уполномоченный по правам ребёнка
  Юрисдикция: Защита прав детей
  Когда эффективно: Права ребёнка в школе, больнице, органах опеки
  Почему сюда: Специализируется на детях, имеет авторитет

### ВЫСШИЙ УРОВЕНЬ (когда всё остальное не помогло)
- **president_admin** — Администрация Президента
  Юрисдикция: Приём обращений к Президенту
  Когда эффективно: Все органы бездействуют, системные проблемы
  Почему сюда: Обращения берутся на контроль, "эффект сверху"

## ФОРМАТ ОТВЕТА (строго JSON):
{
    "recipients": [
        {
            "id": "код_органа",
            "name": "Название органа",
            "priority": "primary" или "secondary",
            "reason": "КРАТКОЕ объяснение почему ИМЕННО СЮДА стоит обратиться в ДАННОЙ ситуации"
        }
    ]
}

ПРАВИЛА:
1. Рекомендуй 2-4 ОСНОВНЫХ (primary) получателя и 1-3 ДОПОЛНИТЕЛЬНЫХ (secondary)
2. Для КАЖДОГО объясни КОНКРЕТНО почему в данной ситуации он релевантен
3. Учитывай иерархию: сначала профильный орган, потом надзорный (прокуратура)
4. Если ситуация криминальная — добавь полицию/СК
5. МОЖЕШЬ предлагать ЛЮБЫЕ релевантные органы, даже если их нет в списке выше! 
   Для таких органов используй id="custom_X" (где X — номер) и обязательно укажи полное название.
   Примеры: региональные органы, специализированные службы, общественные организации."""

        user_prompt = f"""Проанализируй жалобу и определи получателей:

КАТЕГОРИЯ: {context.get('category_name', 'Не указана')}

СУТЬ ПРОБЛЕМЫ:
{qa_text if qa_text else 'Информация не предоставлена'}

Определи 2-4 ОСНОВНЫХ (primary) и 1-3 ДОПОЛНИТЕЛЬНЫХ (secondary) получателя.
Для КАЖДОГО получателя напиши КОНКРЕТНУЮ причину почему в ДАННОЙ ситуации стоит туда обратиться.

JSON:"""

        messages = [
            {"role": "system", "content": system_prompt},
            {"role": "user", "content": user_prompt}
        ]
        
        result = self._make_request(messages, temperature=0.3)
        
        if result:
            json_str = self._extract_json(result)
            if json_str:
                try:
                    return json.loads(json_str)
                except:
                    pass
        
        return None


# Singleton instance
llm_service = LLMService()
